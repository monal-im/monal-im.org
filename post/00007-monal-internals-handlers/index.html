<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Monal Internals - Handlers framework | Monal</title>
<meta name=keywords content><meta name=description content="In this new series, I want to shine some light onto specific parts of Monal&rsquo;s internals. It&rsquo;s dedicated to programmers or people curious about how Monal works internally. If you want to give some feedback, feel free to send an email to thilo@monal-im.org
Handlers Handlers in Monal are something like serializable callbacks. In iOS the app can get frozen or even killed any time and the push implementation requires the complete app state to frequently transition between the Main App and the Notification Service App Extension (NSE)."><meta name=author content="Thilo Molitor"><link crossorigin=anonymous href=/monal-im.org/assets/css/stylesheet.1ae742f00bc5f2d0a3081012780dcc1b3bd5bedc9543ac834ee6c4a2376d6d05.css integrity="sha256-GudC8AvF8tCjCBASeA3MGzvVvtyVQ6yDTubEojdtbQU=" rel="preload stylesheet" as=style fetchpriority=high><link rel=apple-touch-icon sizes=57x57 href=https://monal-im.github.io/monal-im.org/favicons/logo_hubff9d9469274f9ee0f1eabb9b6ec5939_192532_57x0_resize_q50_linear_3.png fetchpriority=medium><link rel=apple-touch-icon sizes=60x60 href=https://monal-im.github.io/monal-im.org/favicons/logo_hubff9d9469274f9ee0f1eabb9b6ec5939_192532_60x0_resize_q50_linear_3.png fetchpriority=medium><link rel=apple-touch-icon sizes=72x72 href=https://monal-im.github.io/monal-im.org/favicons/logo_hubff9d9469274f9ee0f1eabb9b6ec5939_192532_72x0_resize_q50_linear_3.png fetchpriority=medium><link rel=apple-touch-icon sizes=76x76 href=https://monal-im.github.io/monal-im.org/favicons/logo_hubff9d9469274f9ee0f1eabb9b6ec5939_192532_76x0_resize_q50_linear_3.png fetchpriority=medium><link rel=apple-touch-icon sizes=114x114 href=https://monal-im.github.io/monal-im.org/favicons/logo_hubff9d9469274f9ee0f1eabb9b6ec5939_192532_114x0_resize_q50_linear_3.png fetchpriority=low><link rel=apple-touch-icon sizes=120x120 href=https://monal-im.github.io/monal-im.org/favicons/logo_hubff9d9469274f9ee0f1eabb9b6ec5939_192532_120x0_resize_q50_linear_3.png fetchpriority=low><link rel=apple-touch-icon sizes=144x144 href=https://monal-im.github.io/monal-im.org/favicons/logo_hubff9d9469274f9ee0f1eabb9b6ec5939_192532_144x0_resize_q50_linear_3.png fetchpriority=low><link rel=apple-touch-icon sizes=152x152 href=https://monal-im.github.io/monal-im.org/favicons/logo_hubff9d9469274f9ee0f1eabb9b6ec5939_192532_152x0_resize_q50_linear_3.png fetchpriority=low><link rel=apple-touch-icon sizes=180x180 href=https://monal-im.github.io/monal-im.org/favicons/logo_hubff9d9469274f9ee0f1eabb9b6ec5939_192532_180x0_resize_q50_linear_3.png fetchpriority=low><link rel=icon type=image/x-icon href=https://monal-im.github.io/monal-im.org/favicons/favicon.ico fetchpriority=medium><link rel=icon type=image/png sizes=16x16 href=https://monal-im.github.io/monal-im.org/favicons/logo_hubff9d9469274f9ee0f1eabb9b6ec5939_192532_16x0_resize_q50_linear_3.png fetchpriority=medium><link rel=icon type=image/png sizes=32x32 href=https://monal-im.github.io/monal-im.org/favicons/logo_hubff9d9469274f9ee0f1eabb9b6ec5939_192532_32x0_resize_q50_linear_3.png fetchpriority=medium><link rel=icon type=image/png sizes=96x96 href=https://monal-im.github.io/monal-im.org/favicons/logo_hubff9d9469274f9ee0f1eabb9b6ec5939_192532_96x0_resize_q50_linear_3.png fetchpriority=low><link rel=icon type=image/png sizes=128x128 href=https://monal-im.github.io/monal-im.org/favicons/logo_hubff9d9469274f9ee0f1eabb9b6ec5939_192532_128x0_resize_q50_linear_3.png fetchpriority=low><link rel=icon type=image/png sizes=196x196 href=https://monal-im.github.io/monal-im.org/favicons/logo_hubff9d9469274f9ee0f1eabb9b6ec5939_192532_196x0_resize_q50_linear_3.png fetchpriority=low><link rel=mask-icon color=red href=favicons/safari-pinned-tab.svg fetchpriority=low><meta name=application-name content="Monal-IM"><meta name=msapplication-TileColor content="#FFFFFF"><meta name=msapplication-square70x70logo content="https://monal-im.github.io/monal-im.org/favicons/logo_hubff9d9469274f9ee0f1eabb9b6ec5939_192532_70x0_resize_q50_linear_3.png" fetchpriority=medium><meta name=msapplication-TileImage content="https://monal-im.github.io/monal-im.org/favicons/logo_hubff9d9469274f9ee0f1eabb9b6ec5939_192532_144x0_resize_q50_linear_3.png" fetchpriority=low><meta name=msapplication-square150x150logo content="https://monal-im.github.io/monal-im.org/favicons/logo_hubff9d9469274f9ee0f1eabb9b6ec5939_192532_150x0_resize_q50_linear_3.png" fetchpriority=low><meta name=msapplication-square310x310logo content="https://monal-im.github.io/monal-im.org/favicons/logo_hubff9d9469274f9ee0f1eabb9b6ec5939_192532_310x0_resize_q50_linear_3.png" fetchpriority=low><meta property="og:title" content="Monal Internals - Handlers framework"><meta property="og:description" content="In this new series, I want to shine some light onto specific parts of Monal&rsquo;s internals. It&rsquo;s dedicated to programmers or people curious about how Monal works internally. If you want to give some feedback, feel free to send an email to thilo@monal-im.org
Handlers Handlers in Monal are something like serializable callbacks. In iOS the app can get frozen or even killed any time and the push implementation requires the complete app state to frequently transition between the Main App and the Notification Service App Extension (NSE)."><meta property="og:type" content="article"><meta property="og:url" content="https://monal-im.github.io/monal-im.org/post/00007-monal-internals-handlers/"><meta property="article:section" content="post"><meta property="article:published_time" content="2023-07-12T00:00:00+00:00"><meta property="article:modified_time" content="2023-07-12T00:00:00+00:00"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://monal-im.github.io/monal-im.org/post/"},{"@type":"ListItem","position":2,"name":"Monal Internals - Handlers framework","item":"https://monal-im.github.io/monal-im.org/post/00007-monal-internals-handlers/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Monal Internals - Handlers framework","name":"Monal Internals - Handlers framework","description":"In this new series, I want to shine some light onto specific parts of Monal\u0026rsquo;s internals. It\u0026rsquo;s dedicated to programmers or people curious about how Monal works internally. If you want to give some feedback, feel free to send an email to thilo@monal-im.org\nHandlers Handlers in Monal are something like serializable callbacks. In iOS the app can get frozen or even killed any time and the push implementation requires the complete app state to frequently transition between the Main App and the Notification Service App Extension (NSE).","keywords":[],"articleBody":"In this new series, I want to shine some light onto specific parts of Monal‚Äôs internals. It‚Äôs dedicated to programmers or people curious about how Monal works internally. If you want to give some feedback, feel free to send an email to thilo@monal-im.org\nHandlers Handlers in Monal are something like serializable callbacks. In iOS the app can get frozen or even killed any time and the push implementation requires the complete app state to frequently transition between the Main App and the Notification Service App Extension (NSE). Using normal callbacks (called blocks in ObjC) is not possible because blocks are not serializable which means they could not survive an app kill or transition to / from the NSE.\nShort overview:\nSimple generalized concept usable throughout the app Leverages dynamic language features of ObjC ‚ÄúSerializable callbacks‚Äù to class / instance methods of ObjC classes Bind values (not vars) when creating a handler (e.g. to bind state to handler that can be serialized together with the handler) Bind vars when calling handler (overwriting creation-time bound values having the same name) Used in various places throughout the app like the IQ or PubSub framework (see Code examples found in the wild) Jump directly to list of supported data types Usage description with examples Define handler method This will be a static class method and doesn‚Äôt have to be declared in any interface to be usable. The argument number or order does not matter, feel free to reorder or even remove arguments you don‚Äôt need. Arguments declared with $$-prefix are mandatory and can not be removed, though. Arguments with $_-prefix are optional and can be removed. Primitive datatypes like BOOL, int, NSINTEGER (aka $$INTEGER) etc. can not be imported as optional and are always mandatory.\n$$class_handler(myHandlerName, $_ID(xmpp*, account), $$BOOL(success)) // your code comes here // variables defined/imported: account (optional), success (mandatory) $$ Instance handlers are instance methods instead of static methods. You need to specify on which instance these handlers should operate. The instance extraxtion statement (the second argument to $$instance_handler() can be everything that returns an objc object. For example: account.omemo or [account getInstanceToUse] or just account.\n$$instance_handler(myHandlerName, instanceToUse, $$ID(xmpp*, account), $$BOOL(success)) // your code comes here // 'self' is now the instance of the class extracted by the instanceToUse statement. // instead of the class instance as it would be if $$class_handler() was used instead of $$instance_handler() // variables defined/imported: account, success (both mandatory) $$ Call defined handlers Calling a defined handler is simple, just create a handler object using $newHandler() and $call() it.\nMLHandler* h = $newHandler(ClassName, myHandlerName); $call(h); Bind variables when creating a handler You can bind variables to MLHandler objects when creating them and when invoking them. Variables supplied on invocation overwrite variables supplied when creating the handler if the names are equal. Variables bound to the handler when creating it have to conform to the NSCoding protocol to make the handler serializable.\nNSString* var1 = @\"value\"; MLHandler* h = $newHandler(ClassName, myHandlerName, $ID(var1), $BOOL(success, YES) })); xmpp* account = nil; $call(h, $ID(account), $ID(otherAccountVarWithSameValue, account)) Usable shortcuts to create MLHandler objects: $newHandler(ClassName, handlerName, boundArgs...) $newHandlerWithInvalidation(ClassName, handlerName, invalidationHandlerName, boundArgs...) Using invalidation handlers You can add an invalidation method to a handler when creating the MLHandler object (after invalidating a handler you can not call or invalidate it again!). Invalidation handlers can be instance handlers or static handlers, just like with ‚Äúnormal‚Äù handlers:\n// definition of normal handler method as instance_handler $$instance_handler(myHandlerName, [account getInstanceToUse], $_ID(xmpp*, account), $$BOOL(success)) // your code comes here // 'self' is now the instance of the class extracted by [account getInstanceToUse] // instead of the class instance as it would be if $$class_handler() was used instead of $$instance_handler() $$ // definition of invalidation method $$class_handler(myInvalidationHandlerName, $$BOOL(done), $_ID(NSString*, var1)) // your code comes here // variables imported: var1, done // variables that could have been imported according to $newHandler and $call below: var1, success, done $$ MLHandler* h = $newHandlerWithInvalidation(ClassName, myHandlerName, myInvalidationHandlerName, $ID(var1, @\"value\"), $BOOL(success, YES) })); // call invalidation method with \"done\" argument set to YES $invalidate(h, $BOOL(done, YES)) Available data types The following datatypes can be bound to a handler defining them using the corresponding definitions having either the $$ or $_ prefix. If the single argument binding is used, the value is bound using the same name like the var the value is coming from (in this example: name).\ndefine: $$ID(NSObject*, name), $_ID(NSObject*, name), bind: $ID(name), $ID(name, value) define: $$HANDLER(name), $_HANDLER(name), bind: $HANDLER(name), $HANDLER(name, value) define: $$BOOL(name), bind: $BOOL(name), $BOOL(name, value) define: $$INT(name), bind: $INT(name), $INT(name, value) define: $$DOUBLE(name), bind: $DOUBLE(name), $DOUBLE(name, value) define: $$INTEGER(name), bind: $INTEGER(name), $INTEGER(name, value), this corresponds to the NSInteger type alias define: $$UINTEGER(name), bind: $UINTEGER(name), $UINTEGER(name, value), this corresponds to the NSUInteger type alias Code examples found in the wild Enabling carbons if([features containsObject:@\"urn:xmpp:carbons:2\"]) { DDLogInfo(@\"got disco result with carbons ns\"); if(!account.connectionProperties.usingCarbons2) { DDLogInfo(@\"enabling carbons\"); XMPPIQ* carbons = [[XMPPIQ alloc] initWithType:kiqSetType]; [carbons addChildNode:[[MLXMLNode alloc] initWithElement:@\"enable\" andNamespace:@\"urn:xmpp:carbons:2\"]]; [account sendIq:carbons withHandler:$newHandler(self, handleCarbonsEnabled)]; } } $$class_handler(handleCarbonsEnabled, $$ID(xmpp*, account), $$ID(XMPPIQ*, iqNode)) if([iqNode check:@\"/","wordCount":"989","inLanguage":"en","datePublished":"2023-07-12T00:00:00Z","dateModified":"2023-07-12T00:00:00Z","author":{"@type":"Person","name":"Thilo Molitor"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://monal-im.github.io/monal-im.org/post/00007-monal-internals-handlers/"},"publisher":{"@type":"Organization","name":"Monal","logo":{"@type":"ImageObject","url":"https://monal-im.github.io/monal-im.org/favicon.ico"}}}</script></head><body id=top><header class=header><nav class=nav><div class=logo><a href=https://monal-im.github.io/monal-im.org/ accesskey=h title="Monal (Alt + H)">Monal</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li></ul></div></div><ul id=menu><li class=menu-item><a href=/monal-im.org/install/ title=Install><span>Install</span></a></li><li class=menu-item><a href=/monal-im.org/support/ title=Support><span>Support</span></a></li><li class=menu-item><a href=/monal-im.org/post/ title=Blog><span>Blog</span></a></li><li class=menu-item><a href=/monal-im.org/publications/ title=Publications><span>Publications</span></a></li><li class=menu-item><a href=/monal-im.org/privacy/ title=Privacy><span>Privacy</span></a></li><li class=menu-item><a href=/monal-im.org/about/ title=About><span>About</span></a></li><li class=menu-item><a href=https://github.com/monal-im/Monal/wiki/FAQ---Frequently-Asked-Questions title=FAQ><span>FAQ</span>&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li><li class=menu-item><a href=/monal-im.org/search/ title="Search üîç (Alt + /)" accesskey=/><span>Search üîç</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">Monal Internals - Handlers framework</h1><div class=post-meta><span title='2023-07-12 00:00:00 +0000 UTC'>12.07.2023</span>&nbsp;¬∑&nbsp;5 min&nbsp;¬∑&nbsp;Thilo Molitor<a href=/index.xml rel="noopener noreferrer" target=_blank>&nbsp;RSS</a>&nbsp;|&nbsp;<a href=https://github.com/monal-im/monal-im.org/tree/staging/content/post/00007-monal-internals-handlers.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=post-content><p>In this new series, I want to shine some light onto specific parts of Monal&rsquo;s internals. It&rsquo;s dedicated to programmers or people curious about how Monal works internally.
If you want to give some feedback, feel free to send an email to <a href=mailto:thilo@monal-im.org>thilo@monal-im.org</a></p><h1 id=handlers>Handlers<a hidden class=anchor aria-hidden=true href=#handlers>#</a></h1><p>Handlers in Monal are something like serializable callbacks.
In iOS the app can get frozen or even killed any time and the push implementation requires the complete app state to frequently
transition between the Main App and the Notification Service App Extension (NSE). Using normal callbacks (called blocks in ObjC)
is not possible because blocks are not serializable which means they could not survive an app kill or transition to / from the NSE.</p><p>Short overview:</p><ul><li>Simple generalized concept usable throughout the app</li><li>Leverages dynamic language features of ObjC</li><li>&ldquo;Serializable callbacks&rdquo; to class / instance methods of ObjC classes</li><li>Bind values (<em>not vars</em>) when creating a handler (e.g. to bind state to handler that can be serialized together with the handler)</li><li>Bind vars when calling handler (overwriting creation-time bound values having the same name)</li><li>Used in various places throughout the app like the IQ or PubSub framework (see <a href=/monal-im.org/post/00007-monal-internals-handlers/#code-examples-found-in-the-wild>Code examples found in the wild</a>)</li><li><a href=/monal-im.org/post/00007-monal-internals-handlers/#available-data-types>Jump directly to list of supported data types</a></li></ul><h2 id=usage-description-with-examples>Usage description with examples<a hidden class=anchor aria-hidden=true href=#usage-description-with-examples>#</a></h2><h3 id=define-handler-method>Define handler method<a hidden class=anchor aria-hidden=true href=#define-handler-method>#</a></h3><p>This will be a static class method and doesn&rsquo;t have to be declared in any
interface to be usable. The argument number or order does not matter,
feel free to reorder or even remove arguments you don&rsquo;t need.
Arguments declared with $$-prefix are mandatory and can not be removed, though.
Arguments with $_-prefix are optional and can be removed.
Primitive datatypes like BOOL, int, NSINTEGER (aka $$INTEGER) etc. can not be
imported as optional and are always mandatory.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objc data-lang=objc><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$$</span>class_handler(myHandlerName, <span style=color:#960050;background-color:#1e0010>$</span>_ID(xmpp<span style=color:#f92672>*</span>, account), <span style=color:#960050;background-color:#1e0010>$$</span><span style=color:#66d9ef>BOOL</span>(success))
</span></span><span style=display:flex><span>    <span style=color:#75715e>// your code comes here
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// variables defined/imported: account (optional), success (mandatory)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>$$</span>
</span></span></code></pre></div><p>Instance handlers are instance methods instead of static methods.
You need to specify on which instance these handlers should operate.
The instance extraxtion statement (the second argument to $$instance_handler() can be everything that
returns an objc object. For example: <code>account.omemo</code> or <code>[account getInstanceToUse]</code> or just <code>account</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objc data-lang=objc><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$$</span>instance_handler(myHandlerName, instanceToUse, <span style=color:#960050;background-color:#1e0010>$$</span>ID(xmpp<span style=color:#f92672>*</span>, account), <span style=color:#960050;background-color:#1e0010>$$</span><span style=color:#66d9ef>BOOL</span>(success))
</span></span><span style=display:flex><span>    <span style=color:#75715e>// your code comes here
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// &#39;self&#39; is now the instance of the class extracted by the instanceToUse statement.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// instead of the class instance as it would be if $$class_handler() was used instead of $$instance_handler()
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// variables defined/imported: account, success (both mandatory)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>$$</span>
</span></span></code></pre></div><h3 id=call-defined-handlers>Call defined handlers<a hidden class=anchor aria-hidden=true href=#call-defined-handlers>#</a></h3><p>Calling a defined handler is simple, just create a handler object using <code>$newHandler()</code> and <code>$call()</code> it.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objc data-lang=objc><span style=display:flex><span>MLHandler<span style=color:#f92672>*</span> h <span style=color:#f92672>=</span> <span style=color:#960050;background-color:#1e0010>$</span>newHandler(ClassName, myHandlerName);
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$</span>call(h);
</span></span></code></pre></div><h3 id=bind-variables-when-creating-a-handler>Bind variables when creating a handler<a hidden class=anchor aria-hidden=true href=#bind-variables-when-creating-a-handler>#</a></h3><p>You can bind variables to MLHandler objects when creating them and when
invoking them. Variables supplied on invocation overwrite variables
supplied when creating the handler if the names are equal.
Variables bound to the handler when creating it have to conform to the
NSCoding protocol to make the handler serializable.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objc data-lang=objc><span style=display:flex><span>NSString<span style=color:#f92672>*</span> var1 <span style=color:#f92672>=</span> <span style=color:#e6db74>@&#34;value&#34;</span>;
</span></span><span style=display:flex><span>MLHandler<span style=color:#f92672>*</span> h <span style=color:#f92672>=</span> <span style=color:#960050;background-color:#1e0010>$</span>newHandler(ClassName, myHandlerName,
</span></span><span style=display:flex><span>        <span style=color:#960050;background-color:#1e0010>$</span>ID(var1),
</span></span><span style=display:flex><span>        <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#66d9ef>BOOL</span>(success, YES)
</span></span><span style=display:flex><span>}));
</span></span><span style=display:flex><span>xmpp<span style=color:#f92672>*</span> account <span style=color:#f92672>=</span> nil;
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$</span>call(h, <span style=color:#960050;background-color:#1e0010>$</span>ID(account), <span style=color:#960050;background-color:#1e0010>$</span>ID(otherAccountVarWithSameValue, account))
</span></span></code></pre></div><h3 id=usable-shortcuts-to-create-mlhandler-objects>Usable shortcuts to create MLHandler objects:<a hidden class=anchor aria-hidden=true href=#usable-shortcuts-to-create-mlhandler-objects>#</a></h3><ul><li><code>$newHandler(ClassName, handlerName, boundArgs...)</code></li><li><code>$newHandlerWithInvalidation(ClassName, handlerName, invalidationHandlerName, boundArgs...)</code></li></ul><h3 id=using-invalidation-handlers>Using invalidation handlers<a hidden class=anchor aria-hidden=true href=#using-invalidation-handlers>#</a></h3><p>You can add an invalidation method to a handler when creating the
MLHandler object (after invalidating a handler you can not call or
invalidate it again!). Invalidation handlers can be instance handlers or static handlers,
just like with &ldquo;normal&rdquo; handlers:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objc data-lang=objc><span style=display:flex><span><span style=color:#75715e>// definition of normal handler method as instance_handler
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>$$</span>instance_handler(myHandlerName, [account getInstanceToUse], <span style=color:#960050;background-color:#1e0010>$</span>_ID(xmpp<span style=color:#f92672>*</span>, account), <span style=color:#960050;background-color:#1e0010>$$</span><span style=color:#66d9ef>BOOL</span>(success))
</span></span><span style=display:flex><span>        <span style=color:#75715e>// your code comes here
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// &#39;self&#39; is now the instance of the class extracted by [account getInstanceToUse]
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// instead of the class instance as it would be if $$class_handler() was used instead of $$instance_handler()
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>$$</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// definition of invalidation method
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>$$</span>class_handler(myInvalidationHandlerName, <span style=color:#960050;background-color:#1e0010>$$</span><span style=color:#66d9ef>BOOL</span>(done), <span style=color:#960050;background-color:#1e0010>$</span>_ID(NSString<span style=color:#f92672>*</span>, var1))
</span></span><span style=display:flex><span>        <span style=color:#75715e>// your code comes here
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// variables imported: var1, done
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// variables that could have been imported according to $newHandler and $call below: var1, success, done
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>$$</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>MLHandler<span style=color:#f92672>*</span> h <span style=color:#f92672>=</span> <span style=color:#960050;background-color:#1e0010>$</span>newHandlerWithInvalidation(ClassName, myHandlerName, myInvalidationHandlerName,
</span></span><span style=display:flex><span>        <span style=color:#960050;background-color:#1e0010>$</span>ID(var1, <span style=color:#e6db74>@&#34;value&#34;</span>),
</span></span><span style=display:flex><span>        <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#66d9ef>BOOL</span>(success, YES)
</span></span><span style=display:flex><span>}));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// call invalidation method with &#34;done&#34; argument set to YES
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>$</span>invalidate(h, <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#66d9ef>BOOL</span>(done, YES))
</span></span></code></pre></div><h3 id=available-data-types>Available data types<a hidden class=anchor aria-hidden=true href=#available-data-types>#</a></h3><p>The following datatypes can be bound to a handler defining them using the corresponding definitions having either the <code>$$</code> or <code>$_</code> prefix.
If the single argument binding is used, the value is bound using the same name like the var the value is coming from (in this example: name).</p><ul><li>define: <code>$$ID(NSObject*, name)</code>, <code>$_ID(NSObject*, name)</code>, bind: <code>$ID(name)</code>, <code>$ID(name, value)</code></li><li>define: <code>$$HANDLER(name)</code>, <code>$_HANDLER(name)</code>, bind: <code>$HANDLER(name)</code>, <code>$HANDLER(name, value)</code></li><li>define: <code>$$BOOL(name)</code>, bind: <code>$BOOL(name)</code>, <code>$BOOL(name, value)</code></li><li>define: <code>$$INT(name)</code>, bind: <code>$INT(name)</code>, <code>$INT(name, value)</code></li><li>define: <code>$$DOUBLE(name)</code>, bind: <code>$DOUBLE(name)</code>, <code>$DOUBLE(name, value)</code></li><li>define: <code>$$INTEGER(name)</code>, bind: <code>$INTEGER(name)</code>, <code>$INTEGER(name, value)</code>, <em>this corresponds to the NSInteger type alias</em></li><li>define: <code>$$UINTEGER(name)</code>, bind: <code>$UINTEGER(name)</code>, <code>$UINTEGER(name, value)</code>, <em>this corresponds to the NSUInteger type alias</em></li></ul><h2 id=code-examples-found-in-the-wild>Code examples found in the wild<a hidden class=anchor aria-hidden=true href=#code-examples-found-in-the-wild>#</a></h2><h3 id=enabling-carbons>Enabling carbons<a hidden class=anchor aria-hidden=true href=#enabling-carbons>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objc data-lang=objc><span style=display:flex><span><span style=color:#66d9ef>if</span>([features containsObject:<span style=color:#e6db74>@&#34;urn:xmpp:carbons:2&#34;</span>])
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    DDLogInfo(<span style=color:#e6db74>@&#34;got disco result with carbons ns&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span>(<span style=color:#f92672>!</span>account.connectionProperties.usingCarbons2)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        DDLogInfo(<span style=color:#e6db74>@&#34;enabling carbons&#34;</span>);
</span></span><span style=display:flex><span>        XMPPIQ<span style=color:#f92672>*</span> carbons <span style=color:#f92672>=</span> [[XMPPIQ alloc] initWithType:kiqSetType];
</span></span><span style=display:flex><span>        [carbons addChildNode:[[MLXMLNode alloc] initWithElement:<span style=color:#e6db74>@&#34;enable&#34;</span> andNamespace:<span style=color:#e6db74>@&#34;urn:xmpp:carbons:2&#34;</span>]];
</span></span><span style=display:flex><span>        [account sendIq:carbons withHandler:<span style=color:#960050;background-color:#1e0010>$</span>newHandler(self, handleCarbonsEnabled)];
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objc data-lang=objc><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$$</span>class_handler(handleCarbonsEnabled, <span style=color:#960050;background-color:#1e0010>$$</span>ID(xmpp<span style=color:#f92672>*</span>, account), <span style=color:#960050;background-color:#1e0010>$$</span>ID(XMPPIQ<span style=color:#f92672>*</span>, iqNode))
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span>([iqNode check:<span style=color:#e6db74>@&#34;/&lt;type=error&gt;&#34;</span>])
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        DDLogWarn(<span style=color:#e6db74>@&#34;carbon enable iq returned error: %@&#34;</span>, [iqNode findFirst:<span style=color:#e6db74>@&#34;error&#34;</span>]);
</span></span><span style=display:flex><span>        [HelperTools postError:[NSString stringWithFormat:NSLocalizedString(<span style=color:#e6db74>@&#34;Failed to enable carbons for account %@&#34;</span>, <span style=color:#e6db74>@&#34;&#34;</span>), account.connectionProperties.identity.jid] withNode:iqNode andAccount:account andIsSevere:YES];
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    account.connectionProperties.usingCarbons2 <span style=color:#f92672>=</span> YES;
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$$</span>
</span></span></code></pre></div><h3 id=fetching-omemo-bundles>Fetching OMEMO bundles<a hidden class=anchor aria-hidden=true href=#fetching-omemo-bundles>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objc data-lang=objc><span style=display:flex><span>NSString<span style=color:#f92672>*</span> bundleNode <span style=color:#f92672>=</span> [NSString stringWithFormat:<span style=color:#e6db74>@&#34;eu.siacs.conversations.axolotl.bundles:%@&#34;</span>, deviceid];
</span></span><span style=display:flex><span>[self.account.pubsub fetchNode:bundleNode from:jid withItemsList:nil andHandler:<span style=color:#960050;background-color:#1e0010>$</span>newHandler(self, handleBundleFetchResult, <span style=color:#960050;background-color:#1e0010>$</span>ID(rid, deviceid))];
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objc data-lang=objc><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$$</span>instance_handler(handleBundleFetchResult, account.omemo, <span style=color:#960050;background-color:#1e0010>$$</span>ID(xmpp<span style=color:#f92672>*</span>, account), <span style=color:#960050;background-color:#1e0010>$$</span>ID(NSString<span style=color:#f92672>*</span>, jid), <span style=color:#960050;background-color:#1e0010>$$</span><span style=color:#66d9ef>BOOL</span>(success), <span style=color:#960050;background-color:#1e0010>$</span>_ID(XMPPIQ<span style=color:#f92672>*</span>, errorIq), <span style=color:#960050;background-color:#1e0010>$</span>_ID(NSString<span style=color:#f92672>*</span>, errorReason), <span style=color:#960050;background-color:#1e0010>$</span>_ID((NSDictionary<span style=color:#f92672>&lt;</span>NSString<span style=color:#f92672>*</span>, MLXMLNode<span style=color:#f92672>*&gt;*</span>), data), <span style=color:#960050;background-color:#1e0010>$$</span>ID(NSString<span style=color:#f92672>*</span>, rid))
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span>(<span style=color:#f92672>!</span>success)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span>(errorIq)
</span></span><span style=display:flex><span>            DDLogError(<span style=color:#e6db74>@&#34;Could not fetch bundle from %@: rid: %@ - %@&#34;</span>, jid, rid, errorIq);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>DDLogError</span>(<span style=color:#e6db74>@&#34;Could not fetch bundle from %@: rid: %@ - %@&#34;</span>, jid, rid, errorReason);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// check that a corresponding buddy exists -&gt; prevent foreign key errors
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        MLXMLNode<span style=color:#f92672>*</span> receivedKeys <span style=color:#f92672>=</span> [data objectForKey:<span style=color:#e6db74>@&#34;current&#34;</span>];
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span>(<span style=color:#f92672>!</span>receivedKeys <span style=color:#f92672>&amp;&amp;</span> data.count <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#75715e>// some clients do not use &lt;item id=&#34;current&#34;&gt;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            receivedKeys <span style=color:#f92672>=</span> [[data allValues] firstObject];
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span>(<span style=color:#f92672>!</span>receivedKeys <span style=color:#f92672>&amp;&amp;</span> data.count <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            DDLogWarn(<span style=color:#e6db74>@&#34;More than one bundle item found from %@ rid: %@&#34;</span>, jid, rid);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span>(receivedKeys)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            [self processOMEMOKeys:receivedKeys forJid:jid andRid:rid];
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$$</span>
</span></span></code></pre></div></div><footer class=post-footer><ul class=post-tags></ul></footer></article></main><footer class=footer><span>&copy; 2024 <a href=https://monal-im.github.io/monal-im.org/>Monal</a></span> ¬∑
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script type=text/javascript src=https://monal-im.github.io/monal-im.org/js/main.min.416309f1329adbd311186e61f8f1d0b56d9c308752b71dd96914593d05ef8166.js integrity="sha256-QWMJ8TKa29MRGG5h+PHQtW2cMIdStx3ZaRRZPQXvgWY="></script></body></html>