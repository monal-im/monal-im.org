<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Push on iOS | Monal</title>
<meta name=keywords content><meta name=description content="I recently wrote a summary about push on iOS in the xmpp.org wiki.
See over here for all the technical details and links to the documentation. I also talked about that topic in my talk &ldquo;Modern XMPP - A story based on Monal&rdquo; linked on the About page over here.
For convenience I&rsquo;d like to summarize some parts of that wiki entry in this blog-post, too.
UPDATE: This post describes the way Monal implements push as well as the pitfalls of implementing it in another way."><meta name=author content="Thilo Molitor"><link crossorigin=anonymous href=/monal-im.org/site/assets/css/stylesheet.1ae742f00bc5f2d0a3081012780dcc1b3bd5bedc9543ac834ee6c4a2376d6d05.css integrity="sha256-GudC8AvF8tCjCBASeA3MGzvVvtyVQ6yDTubEojdtbQU=" rel="preload stylesheet" as=style fetchpriority=high><link rel=apple-touch-icon sizes=57x57 href=https://monal-im.github.io/monal-im.org/site/favicons/logo_hubff9d9469274f9ee0f1eabb9b6ec5939_192532_57x0_resize_q50_linear_3.png fetchpriority=medium><link rel=apple-touch-icon sizes=60x60 href=https://monal-im.github.io/monal-im.org/site/favicons/logo_hubff9d9469274f9ee0f1eabb9b6ec5939_192532_60x0_resize_q50_linear_3.png fetchpriority=medium><link rel=apple-touch-icon sizes=72x72 href=https://monal-im.github.io/monal-im.org/site/favicons/logo_hubff9d9469274f9ee0f1eabb9b6ec5939_192532_72x0_resize_q50_linear_3.png fetchpriority=medium><link rel=apple-touch-icon sizes=76x76 href=https://monal-im.github.io/monal-im.org/site/favicons/logo_hubff9d9469274f9ee0f1eabb9b6ec5939_192532_76x0_resize_q50_linear_3.png fetchpriority=medium><link rel=apple-touch-icon sizes=114x114 href=https://monal-im.github.io/monal-im.org/site/favicons/logo_hubff9d9469274f9ee0f1eabb9b6ec5939_192532_114x0_resize_q50_linear_3.png fetchpriority=low><link rel=apple-touch-icon sizes=120x120 href=https://monal-im.github.io/monal-im.org/site/favicons/logo_hubff9d9469274f9ee0f1eabb9b6ec5939_192532_120x0_resize_q50_linear_3.png fetchpriority=low><link rel=apple-touch-icon sizes=144x144 href=https://monal-im.github.io/monal-im.org/site/favicons/logo_hubff9d9469274f9ee0f1eabb9b6ec5939_192532_144x0_resize_q50_linear_3.png fetchpriority=low><link rel=apple-touch-icon sizes=152x152 href=https://monal-im.github.io/monal-im.org/site/favicons/logo_hubff9d9469274f9ee0f1eabb9b6ec5939_192532_152x0_resize_q50_linear_3.png fetchpriority=low><link rel=apple-touch-icon sizes=180x180 href=https://monal-im.github.io/monal-im.org/site/favicons/logo_hubff9d9469274f9ee0f1eabb9b6ec5939_192532_180x0_resize_q50_linear_3.png fetchpriority=low><link rel=icon type=image/x-icon href=https://monal-im.github.io/monal-im.org/site/favicons/favicon.ico fetchpriority=medium><link rel=icon type=image/png sizes=16x16 href=https://monal-im.github.io/monal-im.org/site/favicons/logo_hubff9d9469274f9ee0f1eabb9b6ec5939_192532_16x0_resize_q50_linear_3.png fetchpriority=medium><link rel=icon type=image/png sizes=32x32 href=https://monal-im.github.io/monal-im.org/site/favicons/logo_hubff9d9469274f9ee0f1eabb9b6ec5939_192532_32x0_resize_q50_linear_3.png fetchpriority=medium><link rel=icon type=image/png sizes=96x96 href=https://monal-im.github.io/monal-im.org/site/favicons/logo_hubff9d9469274f9ee0f1eabb9b6ec5939_192532_96x0_resize_q50_linear_3.png fetchpriority=low><link rel=icon type=image/png sizes=128x128 href=https://monal-im.github.io/monal-im.org/site/favicons/logo_hubff9d9469274f9ee0f1eabb9b6ec5939_192532_128x0_resize_q50_linear_3.png fetchpriority=low><link rel=icon type=image/png sizes=196x196 href=https://monal-im.github.io/monal-im.org/site/favicons/logo_hubff9d9469274f9ee0f1eabb9b6ec5939_192532_196x0_resize_q50_linear_3.png fetchpriority=low><link rel=mask-icon color=red href=favicons/safari-pinned-tab.svg fetchpriority=low><meta name=application-name content="Monal-IM"><meta name=msapplication-TileColor content="#FFFFFF"><meta name=msapplication-square70x70logo content="https://monal-im.github.io/monal-im.org/site/favicons/logo_hubff9d9469274f9ee0f1eabb9b6ec5939_192532_70x0_resize_q50_linear_3.png" fetchpriority=medium><meta name=msapplication-TileImage content="https://monal-im.github.io/monal-im.org/site/favicons/logo_hubff9d9469274f9ee0f1eabb9b6ec5939_192532_144x0_resize_q50_linear_3.png" fetchpriority=low><meta name=msapplication-square150x150logo content="https://monal-im.github.io/monal-im.org/site/favicons/logo_hubff9d9469274f9ee0f1eabb9b6ec5939_192532_150x0_resize_q50_linear_3.png" fetchpriority=low><meta name=msapplication-square310x310logo content="https://monal-im.github.io/monal-im.org/site/favicons/logo_hubff9d9469274f9ee0f1eabb9b6ec5939_192532_310x0_resize_q50_linear_3.png" fetchpriority=low><meta property="og:title" content="Push on iOS"><meta property="og:description" content="I recently wrote a summary about push on iOS in the xmpp.org wiki.
See over here for all the technical details and links to the documentation. I also talked about that topic in my talk &ldquo;Modern XMPP - A story based on Monal&rdquo; linked on the About page over here.
For convenience I&rsquo;d like to summarize some parts of that wiki entry in this blog-post, too.
UPDATE: This post describes the way Monal implements push as well as the pitfalls of implementing it in another way."><meta property="og:type" content="article"><meta property="og:url" content="https://monal-im.github.io/monal-im.org/site/post/00005-push-on-ios/"><meta property="article:section" content="post"><meta property="article:published_time" content="2023-02-04T00:00:00+00:00"><meta property="article:modified_time" content="2023-02-13T18:04:48+01:00"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://monal-im.github.io/monal-im.org/site/post/"},{"@type":"ListItem","position":2,"name":"Push on iOS","item":"https://monal-im.github.io/monal-im.org/site/post/00005-push-on-ios/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Push on iOS","name":"Push on iOS","description":"I recently wrote a summary about push on iOS in the xmpp.org wiki.\nSee over here for all the technical details and links to the documentation. I also talked about that topic in my talk \u0026ldquo;Modern XMPP - A story based on Monal\u0026rdquo; linked on the About page over here.\nFor convenience I\u0026rsquo;d like to summarize some parts of that wiki entry in this blog-post, too.\nUPDATE: This post describes the way Monal implements push as well as the pitfalls of implementing it in another way.","keywords":[],"articleBody":"I recently wrote a summary about push on iOS in the xmpp.org wiki.\nSee over here for all the technical details and links to the documentation. I also talked about that topic in my talk “Modern XMPP - A story based on Monal” linked on the About page over here.\nFor convenience I’d like to summarize some parts of that wiki entry in this blog-post, too.\nUPDATE: This post describes the way Monal implements push as well as the pitfalls of implementing it in another way. I tried to make this clearer in the text now.\nBackground knowledge: Push on iOS On iOS there are several push modes having different properties. All modes, except VoiIP pushes, have in common, that they only provide 30 seconds of background time.\nVoIP pushes: MUST always make the device ring via Apple’s CallKit framework. You can’t use these pushes to silently retrieve messages or other XMPP stanzas in the background. Low priority pushes: These pushes don’t show any user-visible notification, but they can be dropped or arbitrarily delayed by Apple. They grant 30 seconds of background time. High priority pushes: These MUST show a user-visible notification. They grant 30 seconds of background time. But: Since iOS 13.3, apps having the com.apple.developer.usernotifications.filtering entitlement are allowed to suppress the user-visible notification. To cite Apple: This entitlement is intended for certain types of apps — such as messaging apps or location sharing apps — that use notification service extensions to receive push notifications without delivering notifications to the user.\nHigh priority pushes in combination with the com.apple.developer.usernotifications.filtering entitlement are not only used by Monal, but some other popular messaging apps, too (links to the source):\nWhatsApp Signal Threema Telegram (binary) Monal Monal is using this entitlement to wake up background processing without sending any message data through Apple’s servers (not even ecrypted data). When iOS grants the app it’s 30 seconds background time because of the incoming push, Monal then connects to the XMPP server over the network to retrieve the actual message and display a notification to the user, if needed.\nSignal does exactly the same: It uses push only to wake up the app and then fetches the messages using a dedicated network connection: Example in Signal’s code\nThis way Monal avoids all of the pitfalls depicted below!\nDiving deeper: Some more details about iOS push and XMPP The following explanations and thoughts are a bit more technical and require some understanding of the XMPP protocol and it’s inner workings.\nPush server implementations and iOS time limits Pushes of all types (see above) can only wake up the iOS app for 30 seconds. But in most cases that’s more than enough to connect to the xmpp server and retrieve pending stanzas (if using the entitlement mentioned above and XEP-0198, it is even possible to get pushes for iq stanzas etc., thus behaving like being permanently connected while still sleeping most of the time because of CSI). Even if the 30 seconds don’t suffice, the client can disconnect and both, Prosody and eJabberd, will send another push if there are still unacked stanzas in the XEP-0198 queue. This will give the app another 30 seconds. Even longer catchups lasting for \u003e 5 minutes can be done completely in the background this way (observed in the wild with Monal stable).\nThis means that even with the 30 second time limit in place, it usually is possible to do a longer lasting catchup completely in the background, effectively extending the time limit to several minutes. This obviously only holds, if you use the com.apple.developer.usernotifications.filtering entitlement and connect directly to the xmpp server and is hardly possible if you try to transport stanzas through the push sent through Apple (see below).\nPitfalls: Transporting (encrypted) xmpp message stanzas through push (out of band) When using the iOS push infrastructure provided by apple for transporting (encrypted) stanzas out of band, multiple things have to be considered. First of all, pushes can get lost. That frequently happens if the device was in flight mode while the push was sent. Second, xmpp is a streaming protocol, strongly relying on the ordering of stanza (even inter-type ordering like the ordering of message and iq stanzas for mam). The order of message stanza matters for other XEPs, too (for example message retraction or last message correction). Using the iOS push service which is loosing pushes or even only sending pushes for a particular type of stanza (message stanzas having a body for example) breaks this ordering of events that every XEP implicitly relies upon. The payload sizes allowed for each push are also somewhat low (~4kb including some of the push metadata). OMEMO’s self-healing through key-transport-elements requires the client to send those key-transport message stanzas once a broken session gets detected. But using the push service for data transport is a one way channel only.\nLast but not least the UX can be really degraded if a user does not open the app for some hours (while still receiving push notifications). Once they open the app, a long mam catchup has to be waited for until the ui does reflect what the user already saw in notifications. If the device has no connectivity when the user opens it, they might even be really confused why those messages they alread saw a notification for are not displayed in the app at all). Writing incoming messages to the database to solve this will only make the ordering problem depicted above harder. The client not being able to execute the OMEMO self-healing stuff mentioned above will degrade UX further.\nNOT using the entitlement mentioned above will prevent the client from receiving push notifications for XEP-0333 read markers and remove already displayed notifications instead of posting a new one (because apps not having that entitlement are forced to show a notification for each incoming high priority push, even if the push was only for a XEP-0333 read marker). To be clear: without that entitlement neither message retraction nor XEP-0333 read markers can be implemented reliably!\nAnd if an app has the entitlement: why bother delivering some stanzas out of band and running into the ordering problem if the app could as well connect to the xmpp server in the background and retrieve all pending stanzas in the right order?\n","wordCount":"1050","inLanguage":"en","datePublished":"2023-02-04T00:00:00Z","dateModified":"2023-02-13T18:04:48+01:00","author":{"@type":"Person","name":"Thilo Molitor"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://monal-im.github.io/monal-im.org/site/post/00005-push-on-ios/"},"publisher":{"@type":"Organization","name":"Monal","logo":{"@type":"ImageObject","url":"https://monal-im.github.io/monal-im.org/site/favicon.ico"}}}</script></head><body id=top><header class=header><nav class=nav><div class=logo><a href=https://monal-im.github.io/monal-im.org/site/ accesskey=h title="Monal (Alt + H)">Monal</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li></ul></div></div><ul id=menu><li class=menu-item><a href=/monal-im.org/site/install/ title=Install><span>Install</span></a></li><li class=menu-item><a href=/monal-im.org/site/support/ title=Support><span>Support</span></a></li><li class=menu-item><a href=/monal-im.org/site/post/ title=Blog><span>Blog</span></a></li><li class=menu-item><a href=/monal-im.org/site/publications/ title=Publications><span>Publications</span></a></li><li class=menu-item><a href=/monal-im.org/site/privacy/ title=Privacy><span>Privacy</span></a></li><li class=menu-item><a href=/monal-im.org/site/about/ title=About><span>About</span></a></li><li class=menu-item><a href=https://github.com/monal-im/Monal/wiki/FAQ---Frequently-Asked-Questions title=FAQ><span>FAQ</span>&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li><li class=menu-item><a href=/monal-im.org/site/search/ title="Search 🔍 (Alt + /)" accesskey=/><span>Search 🔍</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">Push on iOS</h1><div class=post-meta><span title='2023-02-04 00:00:00 +0000 UTC'>04.02.2023</span>&nbsp;·&nbsp;5 min&nbsp;·&nbsp;Thilo Molitor<a href=/index.xml rel="noopener noreferrer" target=_blank>&nbsp;RSS</a>&nbsp;|&nbsp;<a href=https://github.com/monal-im/monal-im.org/tree/staging/content/post/00005-Push%20on%20iOS.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=post-content><p>I recently wrote a summary about push on iOS in the xmpp.org wiki.<br>See <a href=https://wiki.xmpp.org/web/Push_notifications>over here</a> for all the technical details and links to the documentation.
I also talked about that topic in my talk &ldquo;<em>Modern XMPP - A story based on Monal</em>&rdquo; linked <a href=/monal-im.org/site/about/>on the About page over here</a>.<br>For convenience I&rsquo;d like to summarize some parts of that wiki entry in this blog-post, too.</p><p><strong>UPDATE:</strong> This post describes the way Monal implements push as well as the pitfalls of implementing it in another way. I tried to make this clearer in the text now.</p><h1 id=background-knowledge-push-on-ios>Background knowledge: Push on iOS<a hidden class=anchor aria-hidden=true href=#background-knowledge-push-on-ios>#</a></h1><p>On iOS there are several push modes having different properties. All modes, except VoiIP pushes, have in common, that they only provide 30 seconds of background time.</p><ul><li><strong>VoIP pushes:</strong> MUST always make the device ring via Apple&rsquo;s CallKit framework. You can&rsquo;t use these pushes to silently retrieve messages or other XMPP stanzas in the background.</li><li><strong>Low priority pushes:</strong> These pushes don&rsquo;t show any user-visible notification, but they can be dropped or arbitrarily delayed by Apple. They grant 30 seconds of background time.</li><li><strong>High priority pushes:</strong> These MUST show a user-visible notification. They grant 30 seconds of background time.<ul><li><strong>But:</strong> Since iOS 13.3, apps having the <code>com.apple.developer.usernotifications.filtering</code> entitlement are allowed to suppress the user-visible notification. To cite Apple:<blockquote><p>This entitlement is intended for certain types of apps — such as messaging apps or location sharing apps — that use notification service extensions to receive push notifications without delivering notifications to the user.</p></blockquote></li></ul></li></ul><p>High priority pushes in combination with the <code>com.apple.developer.usernotifications.filtering</code> entitlement are not only used by Monal, but some other popular messaging apps, too (links to the source):</p><ul><li><a href="https://www.reddit.com/r/TweakBounty/comments/z9oyf7/comment/iyirqor/?utm_source=reddit&utm_medium=web2x&context=3">WhatsApp</a></li><li><a href=https://github.com/signalapp/Signal-iOS/blob/main/SignalNSE/SignalNSE-AppStore.entitlements#L7>Signal</a></li><li><a href=https://github.com/threema-ch/threema-ios/blob/main/ThreemaNotificationExtension/SupportingFiles/ThreemaForWorkRedNotificationExtension.entitlements#L7>Threema</a></li><li><a href=https://github.com/TelegramMessenger/Telegram-iOS/blob/master/build-system/fake-codesigning/profiles/NotificationService.mobileprovision>Telegram</a> (binary)</li></ul><h1 id=monal>Monal<a hidden class=anchor aria-hidden=true href=#monal>#</a></h1><p>Monal is using this entitlement to wake up background processing without sending any message data through Apple&rsquo;s servers (not even ecrypted data).
When iOS grants the app it&rsquo;s 30 seconds background time because of the incoming push, Monal then connects to the XMPP server over the network to retrieve the actual message
and display a notification to the user, if needed.</p><p>Signal does exactly the same: It uses push only to wake up the app and then fetches the messages using a dedicated network connection: <a href=https://github.com/signalapp/Signal-iOS/blob/main/SignalNSE/NotificationService.swift#L236>Example in Signal&rsquo;s code</a></p><p><strong>This way Monal avoids all of the pitfalls depicted below!</strong></p><h1 id=diving-deeper-some-more-details-about-ios-push-and-xmpp>Diving deeper: Some more details about iOS push and XMPP<a hidden class=anchor aria-hidden=true href=#diving-deeper-some-more-details-about-ios-push-and-xmpp>#</a></h1><p>The following explanations and thoughts are a bit more technical and require some understanding of the XMPP protocol and it&rsquo;s inner workings.</p><h2 id=push-server-implementations-and-ios-time-limits>Push server implementations and iOS time limits<a hidden class=anchor aria-hidden=true href=#push-server-implementations-and-ios-time-limits>#</a></h2><p>Pushes of all types (see above) can only wake up the iOS app for 30 seconds. But in most cases that&rsquo;s more than enough to connect to the xmpp server and retrieve pending stanzas (if using the entitlement mentioned above and XEP-0198, it is even possible to get pushes for iq stanzas etc., thus behaving like being permanently connected while still sleeping most of the time because of CSI).
Even if the 30 seconds don&rsquo;t suffice, the client can disconnect and both, Prosody and eJabberd, will send another push if there are still unacked stanzas in the XEP-0198 queue. This will give the app another 30 seconds. Even longer catchups lasting for > 5 minutes can be done completely in the background this way (observed in the wild with Monal stable).</p><p>This means that even with the 30 second time limit in place, it usually is possible to do a longer lasting catchup completely in the background, effectively extending the time limit to several minutes.
This obviously only holds, if you use the <code>com.apple.developer.usernotifications.filtering</code> entitlement and connect directly to the xmpp server and is hardly possible if you try to transport stanzas through the push sent through Apple (see below).</p><h2 id=pitfalls-transporting-encrypted-xmpp-message-stanzas-through-push-out-of-band>Pitfalls: Transporting (encrypted) xmpp message stanzas through push (out of band)<a hidden class=anchor aria-hidden=true href=#pitfalls-transporting-encrypted-xmpp-message-stanzas-through-push-out-of-band>#</a></h2><p>When using the iOS push infrastructure provided by apple for transporting (encrypted) stanzas out of band, multiple things have to be considered. First of all, pushes can get lost. That frequently happens if the device was in flight mode while the push was sent.
Second, xmpp is a streaming protocol, strongly relying on the ordering of stanza (even inter-type ordering like the ordering of message and iq stanzas for mam). The order of message stanza matters for other XEPs, too (for example message retraction or last message correction). Using the iOS push service which is loosing pushes or even only sending pushes for a particular type of stanza (message stanzas having a body for example) breaks this ordering of events that every XEP implicitly relies upon.
The payload sizes allowed for each push are also somewhat low (~4kb including some of the push metadata).
OMEMO&rsquo;s self-healing through key-transport-elements requires the client to send those key-transport message stanzas once a broken session gets detected. But using the push service for data transport is a one way channel only.</p><p>Last but not least the UX can be really degraded if a user does not open the app for some hours (while still receiving push notifications). Once they open the app, a long mam catchup has to be waited for until the ui does reflect what the user already saw in notifications. If the device has no connectivity when the user opens it, they might even be really confused why those messages they alread saw a notification for are not displayed in the app at all). Writing incoming messages to the database to solve this will only make the ordering problem depicted above harder. The client not being able to execute the OMEMO self-healing stuff mentioned above will degrade UX further.</p><p>NOT using the entitlement mentioned above will prevent the client from receiving push notifications for XEP-0333 read markers and remove already displayed notifications instead of posting a new one (because apps not having that entitlement are forced to show a notification for each incoming high priority push, even if the push was only for a XEP-0333 read marker).
<strong>To be clear: without that entitlement neither message retraction nor XEP-0333 read markers can be implemented reliably!</strong><br><em>And if an app has the entitlement:</em> why bother delivering some stanzas out of band and running into the ordering problem if the app could as well connect to the xmpp server in the background and retrieve all pending stanzas in the right order?</p></div><footer class=post-footer><ul class=post-tags></ul></footer></article></main><footer class=footer><span>&copy; 2024 <a href=https://monal-im.github.io/monal-im.org/site/>Monal</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script type=text/javascript src=https://monal-im.github.io/monal-im.org/site/js/main.min.416309f1329adbd311186e61f8f1d0b56d9c308752b71dd96914593d05ef8166.js integrity="sha256-QWMJ8TKa29MRGG5h+PHQtW2cMIdStx3ZaRRZPQXvgWY="></script></body></html>